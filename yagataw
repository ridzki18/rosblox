-- Checkpoint Teleporter — FINAL (Auto Stage Detect + Simple UI)
-- by u + chatgpt

-- ===== CONFIG =====
local START_STAGE = 1     -- fallback start jika tidak ada stage value
local END_STAGE   = 8     -- fallback end & juga batas atas auto-run
local INTERVAL    = 2     -- detik antar aksi
local OFFSET_Y    = 4     -- naik sedikit agar tidak nancep ke part
-- ===================

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local LP = Players.LocalPlayer

-- GUI parent aman (executor/studio)
local function getGuiParent()
    local ok, ui = pcall(function()
        if gethui then
            local h = gethui()
            if typeof(h) == "Instance" then return h end
        end
        return game:GetService("CoreGui")
    end)
    if ok and ui then return ui end
    return LP:WaitForChild("PlayerGui")
end

local function getHRP()
    local char = LP.Character or LP.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart")
end

-- cari BasePart dari instance (Part langsung / PrimaryPart / descendant pertama)
local function ensurePart(inst)
    if not inst then return nil end
    if inst:IsA("BasePart") then return inst end
    if inst:IsA("Model") and inst.PrimaryPart then return inst.PrimaryPart end
    for _, d in ipairs(inst:GetDescendants()) do
        if d:IsA("BasePart") then return d end
    end
    return nil
end

-- ====== Stage Detection ======
local STAGE_KEYWORDS = { "stage", "checkpoint", "level" }

local function isStageLikeName(name)
    name = string.lower(tostring(name or ""))
    for _, kw in ipairs(STAGE_KEYWORDS) do
        if string.find(name, kw, 1, true) then return true end
    end
    return false
end

-- prioritas: leaderstats -> nilai lain di player
local function findStageValueObj()
    local function scan(container)
        if not container then return nil end
        for _, child in ipairs(container:GetDescendants()) do
            if (child:IsA("IntValue") or child:IsA("NumberValue")) and isStageLikeName(child.Name) then
                return child
            end
        end
        return nil
    end

    -- 1) leaderstats
    local ls = LP:FindFirstChild("leaderstats") or LP:FindFirstChildWhichIsA("Folder")
    if ls then
        local v = scan(ls)
        if v then return v end
    end

    -- 2) langsung di player (atau anak-anaknya)
    return scan(LP)
end

local function getCurrentStage()
    local v = findStageValueObj()
    if v then
        local ok, value = pcall(function() return v.Value end)
        if ok and typeof(value) == "number" then
            return math.floor(value), v
        end
    end
    return nil, nil
end

-- ===== UI =====
local parentGui = getGuiParent()

local gui = Instance.new("ScreenGui")
gui.Name = "CP_TP_Final"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = parentGui

local frame = Instance.new("Frame")
frame.Size = UDim2.fromOffset(260, 140)
frame.Position = UDim2.new(0, 20, 0, 150)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
frame.Parent = gui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)
local stroke = Instance.new("UIStroke", frame)
stroke.Color = Color3.fromRGB(120, 120, 160)
stroke.Thickness = 1

local title = Instance.new("TextLabel")
title.BackgroundTransparency = 1
title.Size = UDim2.new(1, -90, 0, 28)
title.Position = UDim2.new(0, 10, 0, 6)
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.TextXAlignment = Enum.TextXAlignment.Left
title.Text = "Auto Stage TP (1-8)"
title.TextColor3 = Color3.fromRGB(235, 235, 245)
title.Parent = frame

-- Hue anim pelan
task.spawn(function()
    local t = 0
    while gui.Parent do
        t += RunService.RenderStepped:Wait()
        title.TextColor3 = Color3.fromHSV((t*0.08)%1, 0.45, 1)
    end
end)

-- Minimize (—)
local minimize = Instance.new("TextButton")
minimize.Size = UDim2.fromOffset(26, 26)
minimize.Position = UDim2.new(1, -64, 0, 7)
minimize.Text = "—"
minimize.TextScaled = true
minimize.Font = Enum.Font.GothamSemibold
minimize.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
minimize.TextColor3 = Color3.fromRGB(230, 230, 240)
minimize.Parent = frame
Instance.new("UICorner", minimize).CornerRadius = UDim.new(0, 8)

-- Close (X)
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.fromOffset(26, 26)
closeBtn.Position = UDim2.new(1, -32, 0, 7)
closeBtn.Text = "X"
closeBtn.TextScaled = true
closeBtn.Font = Enum.Font.GothamSemibold
closeBtn.BackgroundColor3 = Color3.fromRGB(55, 40, 40)
closeBtn.TextColor3 = Color3.fromRGB(255, 230, 230)
closeBtn.Parent = frame
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 8)

-- Toggle
local toggle = Instance.new("TextButton")
toggle.Size = UDim2.new(1, -20, 0, 50)
toggle.Position = UDim2.new(0, 10, 0, 60)
toggle.Font = Enum.Font.GothamBlack
toggle.TextScaled = true
toggle.Text = "Teleport OFF"
toggle.BackgroundColor3 = Color3.fromRGB(65, 30, 30)
toggle.TextColor3 = Color3.fromRGB(255, 235, 235)
toggle.Parent = frame
Instance.new("UICorner", toggle).CornerRadius = UDim.new(0, 10)

-- Draggable via title area
do
    local dragging, p0, f0
    frame.InputBegan:Connect(function(i)
        local onTitle = (i.Position and (i.Position.Y - frame.AbsolutePosition.Y <= 40))
        if i.UserInputType == Enum.UserInputType.MouseButton1 and onTitle then
            dragging, p0, f0 = true, i.Position, frame.Position
            i.Changed:Connect(function()
                if i.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    frame.InputChanged:Connect(function(i)
        if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
            local d = i.Position - p0
            frame.Position = UDim2.new(f0.X.Scale, f0.X.Offset + d.X, f0.Y.Scale, f0.Y.Offset + d.Y)
        end
    end)
end

-- Minimize & Close
local minimized = false
minimize.MouseButton1Click:Connect(function()
    minimized = not minimized
    toggle.Visible = not minimized
    frame.Size = minimized and UDim2.fromOffset(260, 42) or UDim2.fromOffset(260, 140)
    minimize.Text = minimized and "+" or "—"
end)

closeBtn.MouseButton1Click:Connect(function()
    gui:Destroy()
end)

-- Hotkey RightShift: show/hide
UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if gui.Parent and input.KeyCode == Enum.KeyCode.RightShift then
        gui.Enabled = not gui.Enabled
    end
end)

-- ===== Teleport Logic =====
local active = false

local function setToggleUI(on)
    if on then
        toggle.Text = "Teleport ON"
        toggle.BackgroundColor3 = Color3.fromRGB(40, 95, 55)
        toggle.TextColor3 = Color3.fromRGB(230, 255, 230)
    else
        toggle.Text = "Teleport OFF"
        toggle.BackgroundColor3 = Color3.fromRGB(65, 30, 30)
        toggle.TextColor3 = Color3.fromRGB(255, 235, 235)
    end
end

-- Teleport ke checkpoint = nomor
local function tpToCheckpoint(num)
    local cfolder = workspace:FindFirstChild("Checkpoints")
    if not cfolder then return false end
    local node = cfolder:FindFirstChild(tostring(num), false) -- non-recursive sesuai struktur kamu
    if not node then return false end
    local part = ensurePart(node)
    if not part then return false end
    local hrp = getHRP()
    pcall(function()
        hrp.CFrame = CFrame.new(part.Position + Vector3.new(0, OFFSET_Y, 0))
    end)
    return true
end

-- Tunggu sampai stage berubah ke target (atau timeout)
local function waitStageBecome(target, timeout)
    local deadline = time() + (timeout or (INTERVAL + 1))
    while time() < deadline do
        local current = getCurrentStage()
        if current and current >= target then
            return true
        end
        task.wait(0.1)
    end
    return false
end

local function loopAutoStage()
    while active and gui.Parent do
        local currentStage = getCurrentStage()
        if currentStage then
            local nextStage = math.clamp(currentStage + 1, START_STAGE, END_STAGE)
            -- kalau sudah di akhir, optionally berhenti; di sini kita tetap loop biar idempoten
            tpToCheckpoint(nextStage)
            -- tunggu server update stage, kalau tidak update, ya lanjut interval saja
            waitStageBecome(nextStage, INTERVAL + 1)
            task.wait(INTERVAL)
        else
            -- Fallback sekuensial 1..8 kalau tidak ada stage value
            for i = START_STAGE, END_STAGE do
                if not active or not gui.Parent then break end
                tpToCheckpoint(i)
                task.wait(INTERVAL)
            end
        end
    end
end

toggle.MouseButton1Click:Connect(function()
    active = not active
    setToggleUI(active)
    if active then
        task.spawn(loopAutoStage)
    end
end)

LP.CharacterAdded:Connect(function()
    if active and gui.Parent then
        task.delay(1, function()
            if active and gui.Parent then task.spawn(loopAutoStage) end
        end)
    end
end)

print("[Auto Stage TP] Ready. Deteksi stage otomatis; fallback 1-8. Interval:", INTERVAL, "s")
